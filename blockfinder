#!/usr/bin/python
# -*- coding: utf-8 -*-
#
# For the people of Smubworld!
#
import urllib2
import os
import time
import getopt
import sys

__program__ = 'blockfinder'
__url__ = 'http://github.com/ioerror/blockfinder/'
__author__ = 'Jacob Appelbaum <jacob@appelbaum.net>'
__copyright__ = 'Copyright (c) 2009'
__license__ = 'See LICENSE for licensing information'
__version__ = '3.1'

try:
    from future import antigravity
except ImportError:
     antigravity = None

# XXX TODO: Set the user agent and allow the use of a proxy
# Set up a proper Request object, set the user agent and if desired, a proxy
def update_progress_bar(percent_done):
    """Write a progress bar to the console"""
    r, c = os.popen('stty size', 'r').read().split()
    rows, columns = int(r), int(c)
    eff = columns - 3
    sys.stdout.write("[" + "=" * int(percent_done*eff) + ">" + "." * (eff - int(percent_done * eff)) +  "]\x1b[G")
    sys.stdout.flush()

def fetch(url):
    """ Fetch (with progress meter) and return the contents of a url. """
    fetcher = urllib2.urlopen(delegation_url)
    length = int(fetcher.headers.get("content-length"))
    if not length:
        raise Exception("Missing content-length header in reply from server.")
    print "Fetching ", length, " bytes"
    ret = ""
    while True:
        update_progress_bar(float(ret) / length)
        tmp = fetcher.read(1024)
        if len(tmp) == 0:
            return ret
        ret += tmp

def cache_delegation(cache_dir, delegation_url):
    """ Attempt to cache the contents of a delegation url in our cache dir. """
    try:
        os.stat(cache_dir)
    except OSError, e:
        if e.errno == 2:
            if verbose:
                print "Initializing the cache directory..."
            os.mkdir(cache_dir)
        else:
             raise e
    delegation = ""
    print "Fetching " + delegation_url
    delegation = fetch(delegation_url)
    tmp = delegation_url.split('/')
    delegation_file = str(cache_dir) + str(tmp[-1])
    try:
        f = open(delegation_file, 'w')
        f.write(delegation)
        return True
    except Exception, e:
        print repr(e)
        return False
    finally:
        f.close()

def cache_is_dated(cache_dir, cached_files):
    """ Returns True if the mtime of any files in cache dir is > 24hrs."""
    try:
        os.stat(cache_dir)
    except OSError, e:
        print "Did you initialize the cache directory?"
        raise e
    for file in cached_files:
        fstat = os.stat(cache_dir + file)
        if (time.time() - fstat.st_mtime) > 86400:
            return True
    return False

def update_delegation_cache(cache_dir, delegation_urls):
    """ Fetch multiple delegation urls and cache the contents. """
    print "Updating delegation cache..."
    for url in delegation_urls.split():
        try:
            cache_delegation(cache_dir, url)
            return True
        except:
            print "Unable to update delegation for " + url
            return False

def load_delegation(delegation_file):
    """ Load, parse and store the delegation file contents as a list. """
    keys = "rir cc type n nn asn status"
    try:
        f = open(delegation_file, "r")
        delegations = [ dict((k,v) for k,v in zip(keys.split(), line.split("|")))
                        for line in f.readlines() if not line.startswith("#")]
        return delegations
    except OSError, e:
        print repr(e)
    finally:
        f.close()

def load_all_delegations(cache_dir, delegation_urls):
    """ Load all delegations into memory. """
    delegations = []
    for url in delegation_urls.split():
        filename = url.rpartition('/')[-1]
        if verbose:
            print "Attempting to load delegation file into memory: " + filename
        delegations.append(load_delegation(cache_dir + filename))
    return delegations

def lookup_country(cc, delegation):
    """ Return data about a given county code in a supplied delegation. """
    return [d for d in delegation if d['cc'] == cc]

def lookup_type(type, delegation):
    """ Return data about a given type in a supplied delegation. """
    return [d for d in delegation if d['type'] == type]

def usage():
    """ Print usage information. """
    print >> sys.stderr, """
blockfinder  [-c DIR] -i
blockfinder [options] -t COUNTRY

The first form initializes the local cache. The second form queries it.

Understood options (not all of which are implemented yet):
    -h, --help          Show this help and exit
    -v                  Be verbose
    -c, --cachedir DIR  Set the cache directory
    -u, --useragent
    -p, --progress
    -o, --output FILE
    -4, --ipv4          Search IPv4 allocations
    -6, --ipv6          Search IPv6 allocation
    -a, --asn           Search ASN allocations
    -t, --nationstate CC  Set the country to search (given as a two-letter code)

At least one of -t or -i is required, and when in -t mode, at least one of -4,
-6, and -a is required in order to do anything sensible.
"""

def main():
    """ Where the magic starts. """
    try:
        opts, args = getopt.getopt(sys.argv[1:],
                                   "vhc:u:pso:46at:i",
                                   ["verbose", "help", "cachedir=", "useragent=", "progress",
                                    "silent", "output=", "ipv4", "ipv6", "asn", "country=",
                                    "initialize-delegation"])
    except getopt.GetoptError, err:
        print str(err)
        usage()
        sys.exit(2)

    global verbose
    verbose = False
    output = None
    silent = True
    cache_dir = str(os.path.expanduser('~')) + "/.blockfinder/"
    update_delegations = False
    delegation_urls="""
        ftp://ftp.arin.net/pub/stats/arin/delegated-arin-latest
        ftp://ftp.ripe.net/ripe/stats/delegated-ripencc-latest
        ftp://ftp.afrinic.net/pub/stats/afrinic/delegated-afrinic-latest
        ftp://ftp.apnic.net/pub/stats/apnic/delegated-apnic-latest
        ftp://ftp.lacnic.net/pub/stats/lacnic/delegated-lacnic-latest
    """
    delegation_files=[]
    for url in delegation_urls.split():
        filename = url.rpartition('/')
        delegation_files.append(filename[-1])
    update_delegations = False
    requests = []
    country = ""
    for o, a in opts:
        if o == "-v":
            verbose = True
        elif o in ("-h", "--help"):
            usage()
            sys.exit()
        elif o in ("-c", "--cachedir"):
            cache_dir = a
        elif o in ("-u", "--useragent"):
            pass
        elif o in ("-p", "--progress"):
            progress = True
        elif o in ("-s", "--silent"):
            silent = True
        elif o in ("-o", "--output"):
            output = a
        elif o in ("-4", "--ipv4"):
            requests.append("ipv4")
        elif o in ("-6", "--ipv6"):
            requests.append("ipv6")
        elif o in ("-a", "--asn"):
            requests.append("asn")
        # XXX TODO: This should be a positional argument as it's the only manditory one...
        elif o in ("-t", "--nation-state"):
            country = a.upper()
        elif o in ("-i", "--initialize-delegations"):
            update_delegations = True
        else:
            assert False, "Unhandled option; Sorry!"

    # Update and quit of requested
    if update_delegations:
        update_delegation_cache(cache_dir, delegation_urls)
        sys.exit(0)
    if not requests:
        print "Nothing to do. Have you requested anything?"
        print "Example usage: blockfinder -v --ipv4 -t mm"
        sys.exit(1)
    # Check our cache age and warn if it's aged
    total_delegations = 0
    if cache_is_dated(cache_dir, delegation_files) and verbose:
        print "Your delegation cache is older than 24 hours; you probably want to update it."
    delegations = load_all_delegations(cache_dir, delegation_urls)
    for delegation in delegations:
        total_delegations += len(delegation)
    if verbose:
        print "We have %d entries in our delegation cache." % total_delegations
    tmp = []
    resultnum = 0
    matchnum = 0
    for delegation in delegations:
        try:
            results = lookup_country(country, delegation)
            resultnum += len(results)
            for result in results:
                for request in requests:
                    if result['type'] == request:
                        matchnum += 1
                        print result['n']
        except:
            print sys.exc_info()
            pass
    if verbose:
        print "We found %d possible entries in our delegation cache." % resultnum
        print "We found %d matching entries in our delegation cache." % matchnum

if __name__ == "__main__":
    main()
